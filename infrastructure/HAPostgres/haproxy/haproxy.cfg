global
    maxconn 10000
    log stdout format raw local0 info
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    retries 3
    timeout connect 10s
    timeout client 1h
    timeout server 1h
    timeout check 5s

# =============================================================================
# Stats Page
# =============================================================================

listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:${HAPROXY_STATS_PASSWORD:-admin}

# =============================================================================
# Primary PgBouncer Pool (Port 6432) - Main application connection point
# =============================================================================

listen pgbouncer_primary
    bind *:6432
    mode tcp
    option tcplog
    balance roundrobin

    # PgBouncer instances (Swarm service DNS resolves to all replicas)
    server-template pgbouncer 3 pgbouncer:6432 check inter 5s rise 2 fall 3

# =============================================================================
# Direct PostgreSQL Primary (Port 5000) - For admin operations
# =============================================================================

listen postgres_primary
    bind *:5000
    mode tcp
    option tcplog
    option httpchk
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    # Check Patroni REST API to determine primary
    server patroni-node1 patroni-node1:5432 maxconn 100 check port 8008
    server patroni-node2 patroni-node2:5432 maxconn 100 check port 8008
    server patroni-node3 patroni-node3:5432 maxconn 100 check port 8008

# =============================================================================
# Direct PostgreSQL Replicas (Port 5001) - For read-only queries
# =============================================================================

listen postgres_replicas
    bind *:5001
    mode tcp
    option tcplog
    option httpchk
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    balance roundrobin

    # Check Patroni REST API /replica endpoint
    server patroni-node1 patroni-node1:5432 maxconn 100 check port 8008 check-http /replica
    server patroni-node2 patroni-node2:5432 maxconn 100 check port 8008 check-http /replica
    server patroni-node3 patroni-node3:5432 maxconn 100 check port 8008 check-http /replica
