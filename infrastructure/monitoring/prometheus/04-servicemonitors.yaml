---
# ServiceMonitors for SaaSOdoo Platform
#
# ServiceMonitors tell Prometheus which services to scrape.
# Each SaaSOdoo microservice exposes metrics at /metrics endpoint.
#
# Monitored Services:
# - user-service (port 8001)
# - billing-service (port 8004)
# - instance-service (port 8003)
# - notification-service (port 5000)
# - database-service (port 8002)
#
# Infrastructure:
# - PostgreSQL (CloudNativePG)
# - RabbitMQ
# - Redis
# - Traefik
#

---
# User Service Monitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: user-service
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: user-service
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: user-service
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      honorLabels: true

---
# Billing Service Monitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: billing-service
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: billing-service
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: billing-service
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      honorLabels: true

---
# Instance Service Monitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: instance-service
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: instance-service
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: instance-service
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      honorLabels: true

---
# Notification Service Monitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: notification-service
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: notification-service
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: notification-service
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      honorLabels: true

---
# Database Service Monitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: database-service
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: database-service
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: database-service
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      honorLabels: true

---
# RabbitMQ ServiceMonitor
# RabbitMQ Operator exposes Prometheus metrics on port 15692
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rabbitmq
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: messaging
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: rabbitmq
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: prometheus
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# Redis ServiceMonitor
# Note: Redis Failover operator doesn't expose metrics by default
# This ServiceMonitor is a placeholder - metrics require redis-exporter sidecar
# Uncomment when redis-exporter is deployed
# apiVersion: monitoring.coreos.com/v1
# kind: ServiceMonitor
# metadata:
#   name: redis
#   namespace: saasodoo
#   labels:
#     app.kubernetes.io/name: redis
#     app.kubernetes.io/component: cache
#     app.kubernetes.io/part-of: saasodoo
#     prometheus: saasodoo
# spec:
#   selector:
#     matchLabels:
#       app.kubernetes.io/name: redis-cluster
#   namespaceSelector:
#     matchNames:
#       - saasodoo
#   endpoints:
#     - port: metrics
#       path: /metrics
#       interval: 30s
#       scrapeTimeout: 10s

---
# Traefik ServiceMonitor
# Traefik exposes metrics on the admin/dashboard port (8080)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: traefik
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: traefik
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: admin
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# CloudNativePG PostgreSQL PodMonitor
# CNPG exports metrics per-pod on port 9187, so we use PodMonitor
# Uses matchExpressions to automatically monitor all CNPG clusters (current and future)
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: cnpg-clusters
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: saasodoo
    prometheus: saasodoo
spec:
  selector:
    matchExpressions:
    - key: cnpg.io/cluster
      operator: Exists
  namespaceSelector:
    matchNames:
      - saasodoo
  podMetricsEndpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# Kill Bill JMX ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: killbill
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: killbill
    app.kubernetes.io/component: billing-engine
    app.kubernetes.io/part-of: killbill
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: killbill
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# Kill Bill MariaDB ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: killbill-db
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: killbill-db
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: killbill
    prometheus: saasodoo
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: killbill-db
  namespaceSelector:
    matchNames:
      - saasodoo
  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
