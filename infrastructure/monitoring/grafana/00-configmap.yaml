---
# Grafana Configuration
#
# Main configuration for Grafana instance including:
# - Data sources (Prometheus, Alertmanager)
# - Dashboard provisioning
# - Authentication settings
# - Server configuration
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: visualization
    app.kubernetes.io/part-of: saasodoo
data:
  # Main Grafana configuration
  grafana.ini: |
    [server]
    root_url = http://grafana.109.199.108.243.nip.io
    serve_from_sub_path = false

    [security]
    admin_user = admin
    # Password set via secret
    disable_gravatar = true

    [users]
    allow_sign_up = false
    auto_assign_org = true
    auto_assign_org_role = Viewer

    [auth]
    disable_login_form = false

    [auth.anonymous]
    enabled = false

    [dashboards]
    default_home_dashboard_path = /var/lib/grafana/dashboards/saasodoo/saasodoo-overview.json

    # Unified Alerting (Grafana 11+ only supports this)
    [unified_alerting]
    enabled = true

    [feature_toggles]
    enable = publicDashboards

    [log]
    mode = console
    level = info

    [analytics]
    check_for_updates = false
    reporting_enabled = false

---
# Datasource provisioning
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: visualization
    app.kubernetes.io/part-of: saasodoo
data:
  datasources.yaml: |
    apiVersion: 1
    deleteDatasources:
      - name: Prometheus
        orgId: 1

    datasources:
      # Prometheus - Main metrics source
      - name: Prometheus
        type: prometheus
        uid: prometheus
        access: proxy
        url: http://prometheus.monitoring.svc.cluster.local:9090
        isDefault: true
        editable: false
        jsonData:
          httpMethod: POST
          timeInterval: "15s"
          queryTimeout: "60s"
          exemplarTraceIdDestinations:
            - name: traceID
              datasourceUid: tempo

      # Alertmanager - For alert status
      - name: Alertmanager
        type: alertmanager
        uid: alertmanager
        access: proxy
        url: http://alertmanager.monitoring.svc.cluster.local:9093
        editable: false
        jsonData:
          implementation: prometheus

---
# Dashboard provisioning configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-providers
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: visualization
    app.kubernetes.io/part-of: saasodoo
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      # SaaSOdoo custom dashboards
      - name: 'saasodoo'
        orgId: 1
        folder: 'SaaSOdoo'
        folderUid: 'saasodoo'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards/saasodoo

      # Kubernetes dashboards
      - name: 'kubernetes'
        orgId: 1
        folder: 'Kubernetes'
        folderUid: 'kubernetes'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        options:
          path: /var/lib/grafana/dashboards/kubernetes

      # Infrastructure dashboards
      - name: 'infrastructure'
        orgId: 1
        folder: 'Infrastructure'
        folderUid: 'infrastructure'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        options:
          path: /var/lib/grafana/dashboards/infrastructure
