---
# Admin Database Initialization Job
# Creates admin tables and initial super_admin user
#
# Prerequisites:
# 1. Apply 00-cnpg-secret.yaml (creates cnpg-admin-service secret)
# 2. Apply 00-cnpg-database.yaml (creates admin database and admin_service role via CNPG)
# 3. Wait for Database CRD to be ready
# 4. Then apply this job
#
apiVersion: batch/v1
kind: Job
metadata:
  name: admin-db-init
  namespace: saasodoo
  labels:
    app.kubernetes.io/name: admin-service
    app.kubernetes.io/component: database-init
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: admin-service
        app.kubernetes.io/component: database-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: saasodoo-service-sa
      containers:
        - name: db-init
          image: postgres:15-alpine
          env:
            - name: PGHOST
              value: "postgres-cluster-rw.saasodoo.svc.cluster.local"
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: "admin_service"
            - name: PGDATABASE
              value: "admin"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: cnpg-admin-service
                  key: password
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Starting admin database table initialization..."

              # Wait for PostgreSQL cluster and database to be ready
              until psql -c "SELECT 1" > /dev/null 2>&1; do
                echo "Waiting for admin database..."
                sleep 2
              done

              echo "Admin database is ready. Creating tables..."

              # Create tables (idempotent with IF NOT EXISTS)
              psql <<'EOSQL'

              -- Admin users table
              CREATE TABLE IF NOT EXISTS admin_users (
                  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                  email VARCHAR(255) UNIQUE NOT NULL,
                  password_hash VARCHAR(255) NOT NULL,
                  name VARCHAR(255) NOT NULL,
                  role VARCHAR(50) NOT NULL DEFAULT 'operator',
                  is_active BOOLEAN DEFAULT true,
                  last_login_at TIMESTAMP,
                  created_at TIMESTAMP DEFAULT NOW(),
                  updated_at TIMESTAMP DEFAULT NOW(),
                  CONSTRAINT valid_role CHECK (role IN ('operator', 'admin', 'super_admin'))
              );

              -- Admin sessions table
              CREATE TABLE IF NOT EXISTS admin_sessions (
                  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                  admin_user_id UUID REFERENCES admin_users(id) ON DELETE CASCADE,
                  token_hash VARCHAR(255) NOT NULL UNIQUE,
                  expires_at TIMESTAMP NOT NULL,
                  ip_address VARCHAR(45),
                  user_agent TEXT,
                  created_at TIMESTAMP DEFAULT NOW()
              );

              -- Audit log table (append-only)
              CREATE TABLE IF NOT EXISTS audit_logs (
                  id BIGSERIAL PRIMARY KEY,
                  admin_user_id UUID REFERENCES admin_users(id),
                  action VARCHAR(100) NOT NULL,
                  target_type VARCHAR(50) NOT NULL,
                  target_id VARCHAR(255) NOT NULL,
                  target_customer_id UUID,
                  details JSONB,
                  ip_address VARCHAR(45),
                  user_agent TEXT,
                  created_at TIMESTAMP DEFAULT NOW()
              );

              -- Indexes
              CREATE INDEX IF NOT EXISTS idx_admin_sessions_user ON admin_sessions(admin_user_id);
              CREATE INDEX IF NOT EXISTS idx_admin_sessions_token ON admin_sessions(token_hash);
              CREATE INDEX IF NOT EXISTS idx_admin_sessions_expires ON admin_sessions(expires_at);
              CREATE INDEX IF NOT EXISTS idx_audit_logs_admin_user ON audit_logs(admin_user_id);
              CREATE INDEX IF NOT EXISTS idx_audit_logs_target ON audit_logs(target_type, target_id);
              CREATE INDEX IF NOT EXISTS idx_audit_logs_customer ON audit_logs(target_customer_id);
              CREATE INDEX IF NOT EXISTS idx_audit_logs_created ON audit_logs(created_at DESC);
              CREATE INDEX IF NOT EXISTS idx_audit_logs_action ON audit_logs(action);

              -- Trigger for updated_at
              CREATE OR REPLACE FUNCTION update_admin_user_updated_at()
              RETURNS TRIGGER AS $$
              BEGIN
                  NEW.updated_at = NOW();
                  RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              DROP TRIGGER IF EXISTS trigger_admin_user_updated_at ON admin_users;
              CREATE TRIGGER trigger_admin_user_updated_at
                  BEFORE UPDATE ON admin_users
                  FOR EACH ROW
                  EXECUTE FUNCTION update_admin_user_updated_at();

              -- Insert default super_admin (password: admin123 - CHANGE IN PRODUCTION!)
              INSERT INTO admin_users (email, password_hash, name, role)
              VALUES (
                  'admin@saasodoo.com',
                  '$2b$12$vXqnT7JPbgNjqNjvHI5uYuoWN4yt71iXFZW5y2KVF36IQURHva7Ie',
                  'System Administrator',
                  'super_admin'
              ) ON CONFLICT (email) DO UPDATE SET password_hash = EXCLUDED.password_hash;

              EOSQL

              echo "Admin database initialized successfully!"
